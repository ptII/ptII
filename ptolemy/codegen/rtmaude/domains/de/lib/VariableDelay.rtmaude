/***moduleName***/
VARIABLE-DELAY-ACTOR/**/

/***className***/
VariableDelay/**/

/***sharedBlock***/
(tomod VARIABLE-DELAY-ACTOR  is 
  inc ACTOR .

  class VariableDelay .   subclass VariableDelay < Actor .
  eq ^ VariableDelay = Actor .
    
    ---FIXME: hierarchical OO desigin of actors is required. 

  vars O QUE : Oid . var REST : ObjectConfiguration .
  var PORTS : Configuration . vars PI PI' : PortId . var PS : PortStatus .
  var E : Exp . var V TV : Value . var NV : NumberValue . vars T : Time .
  var AM : AssignMap . var MEM : Memory .
  var UPDATED : Bool .

---------------------------------------------------------------------
--- Semantics Steps
---------------------------------------------------------------------

  --- set each status of ports to 'unknown'
  eq prefire(VariableDelay, 
    < O : VariableDelay | 
      parameters : ('delay |-> E ; AM) 
    >) 
   = prefire(^ VariableDelay, 
    < O : VariableDelay | 
      store : 'delay |-> k(E) 
    >) .

  --- Note: Delay actors generate events "later" and hence
  --- do not generate output WHEN their ports are in unknown state
  eq portFixPoints(UPDATED,
     < O : VariableDelay | 
       status : enabled,
       ports :  < PI : OutPort | status : unknown > PORTS 
     > 
     REST) 
   = portFixPoints(true,
     < O : VariableDelay | 
       ports : < PI : OutPort | status : absent > PORTS 
     > REST) .

  *** execute a step for variable delay operators
  *** if 'delay port is present, it should be used instead of delay value.
  *** (it will also updated at the top level as well. )

  eq postfire(VariableDelay, 
    < O : VariableDelay | 
      ports : ( 
        < 'input : InPort | status : present, value : V >
        < 'delay : InPort | status : PS, value : NV >
        < 'output : OutPort | > PORTS), 
      store : 'delay |-> TV ; MEM
    >)
  = evt(event(O ! 'output, V), toTime(if PS == present then NV else TV fi)) 
    postfire(^ VariableDelay, < O : VariableDelay | >) .
endtom)
/**/